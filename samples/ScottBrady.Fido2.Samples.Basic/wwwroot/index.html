<h1>Click to register new (ES256 or RS256)</h1>
<label for="username">Username: </label><input id="username" type="text" />
<button onclick="register()">register</button>
<button onclick="authenticate()">authenticate</button>
<code id="result"></code>

<script>
    if (!window.PublicKeyCredential) {
        console.error("WebAuthn not supported by browser!")
    }

    async function register() {

        // get registration options from relying party
        let username = document.getElementById("username").value;
        let response = await fetch("/fido/register", {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                "username": username,
                "userDisplayName": username
            })
        });
        
        // cleanup options (convert Arrays into Uint8Arrays)
        let options = await response.json();
        options.challenge = new Uint8Array(options.challenge);
        options.user.id = new Uint8Array(options.user.id);
        console.log("options:", options);

        // create new credential
        let credential = await navigator.credentials.create({publicKey: options});
        
        console.log(credential);
        console.log("rawId", btoa(String.fromCharCode.apply(null, new Uint8Array(credential.rawId))));
        console.log("attestationObject", btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.attestationObject))));
        console.log("clientDataJSON", btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.clientDataJSON))));

        // send credentials to relying party
        let result = await fetch("/fido/register", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            
            // body as base64 encoded (automatically decoded by ASP.NET Core)
            body: JSON.stringify({
                id: credential.id,
                rawId: btoa(String.fromCharCode.apply(null, new Uint8Array(credential.rawId))),
                type: credential.type,
                response: {
                    attestationObject: btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.attestationObject))),
                    clientDataJSON: btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.clientDataJSON)))
                }
                // TODO: optional transports
                // transports: credential.response.getTransports(), 
                // TODO: other functions to test
                // extensions: credential.getClientExtensionResults(),
                // authenticatorData: credential.response.getAuthenticatorData(),
                // publicKey: credential.response.getPublicKey(),
                // publicKeyAlgorithm: credential.response.getPublicKeyAlgorithm(),
            })
        });
        
        if (result.ok) {
            let output = document.getElementById("result");
            output.innerText = "Registration complete";
        }
    }

    async function authenticate() {

        // get authentication options from relying party
        let username = document.getElementById("username").value;
        let response = await fetch("/fido/authenticate", {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                "username": username
            })
        });

        // cleanup options (convert Arrays into Uint8Arrays)
        let options = await response.json();
        options.challenge = new Uint8Array(options.challenge);
        console.log("options:", options);

        for (const allowCredential of options.allowCredentials) {
            allowCredential.id = new Uint8Array(allowCredential.id)
        }

        console.log(options.allowCredentials);

        // authenticate credential
        let credential = await navigator.credentials.get({
            publicKey: {
                challenge: options.challenge,
                allowCredentials: options.allowCredentials
            }
        });

        
        console.log(credential);
        console.log("rawId", btoa(String.fromCharCode.apply(null, new Uint8Array(credential.rawId))));
        console.log("authenticatorData", btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.authenticatorData))));
        console.log("signature", btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.signature))));
        console.log("userHandle", btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.userHandle))));
        console.log("clientDataJSON", btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.clientDataJSON))));


        // send result to relying party
        let result = await fetch("/fido/authenticate", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            
            // body as base64 encoded (automatically decoded by ASP.NET Core)
            body: JSON.stringify({
                id: credential.id,
                rawId: btoa(String.fromCharCode.apply(null, new Uint8Array(credential.rawId))),
                type: credential.type,
                response: {
                    authenticatorData: btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.authenticatorData))),
                    signature: btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.signature))),
                    userHandle: btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.userHandle))),
                    clientDataJSON: btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.clientDataJSON)))
                }
            })
        });

        if (result.ok) {
            let output = document.getElementById("result");
            output.innerText = "Authentication complete";
        }
    }
</script>
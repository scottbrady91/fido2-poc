<h1>Click to register new (ES256 or RS256)</h1>
<!--<label for="username">Username: </label><input id="username" type="text" />-->
<button onclick="register()">register</button>
<button onclick="authenticate()">authenticate</button>
<code id="result"></code>

<script>
    if (!window.PublicKeyCredential) {
        console.error("WebAuthn not supported by browser!")
    }

    async function register() {

        let response = await fetch("/fido/register");
        let options = await response.json();
        options.challenge = new Uint8Array(options.challenge); // convert Array into Uint8Array
        options.user.id = new Uint8Array(options.user.id); // convert Array into Uint8Array
        console.log("options:", options);

        let credential = await navigator.credentials.create({
            publicKey: {
                rp: options.rp,
                user: options.user,
                
                challenge: options.challenge,
                pubKeyCredParams: options.pubKeyCredParams,

                timeout: 360000,  // 6 minutes
                // TODO: excludeCredentials
                authenticatorSelection: {
                    // Try to use UV if possible. This is also the default.
                    userVerification: "preferred"
                },
                attestation: options.attestation, // "none"
                // TODO: extensions
                
            }
        });

        
        console.log(credential);
        console.log("rawId", btoa(String.fromCharCode.apply(null, new Uint8Array(credential.rawId))));
        console.log("attestationObject", btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.attestationObject))));
        console.log("clientDataJSON", btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.clientDataJSON))));

        
        let result = await fetch("/fido/register", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                id: credential.id,
                rawId: btoa(String.fromCharCode.apply(null, new Uint8Array(credential.rawId))),
                type: credential.type,
                response: {
                    attestationObject: btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.attestationObject))),
                    clientDataJSON: btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.clientDataJSON)))
                }
                // TODO: optional transports
                // transports: credential.response.getTransports(), 
                // TODO: other functions to test
                // extensions: credential.getClientExtensionResults(),
                // authenticatorData: credential.response.getAuthenticatorData(),
                // publicKey: credential.response.getPublicKey(),
                // publicKeyAlgorithm: credential.response.getPublicKeyAlgorithm(),
            })
        });
        
        if (result.ok) {
            let output = document.getElementById("result");
            output.innerText = "Registration complete";
        }
    }

    async function authenticate() {

        let response = await fetch("/fido/authenticate");
        let options = await response.json();
        options.challenge = new Uint8Array(options.Challenge);
        console.log("options:", options);

        // TODO: casing
        for (const allowCredential of options.AllowCredentials) {
            allowCredential.id = new Uint8Array(allowCredential.Id)
            allowCredential.type = allowCredential.Type
        }

        console.log(options.AllowCredentials);

        let credential = await navigator.credentials.get({
            publicKey: {
                challenge: options.challenge,
                allowCredentials: options.AllowCredentials
            }
        });

        
        console.log(credential);
        console.log("rawId", btoa(String.fromCharCode.apply(null, new Uint8Array(credential.rawId))));
        console.log("authenticatorData", btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.authenticatorData))));
        console.log("signature", btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.signature))));
        console.log("userHandle", btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.userHandle))));
        console.log("clientDataJSON", btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.clientDataJSON))));


        let result = await fetch("/fido/authenticate", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                id: credential.id,
                rawId: btoa(String.fromCharCode.apply(null, new Uint8Array(credential.rawId))),
                type: credential.type,
                // extensions: credential.getClientExtensionResults(),
                // transports: credential.response.getTransports(), 
                // authenticatorData: credential.response.getAuthenticatorData(),
                // publicKey: credential.response.getPublicKey(),
                // publicKeyAlgorithm: credential.response.getPublicKeyAlgorithm(),
                response: {
                    authenticatorData: btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.authenticatorData))),
                    signature: btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.signature))),
                    userHandle: btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.userHandle))),
                    clientDataJSON: btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.clientDataJSON)))
                }
            })
        });

        if (result.ok) {
            let output = document.getElementById("result");
            output.innerText = "Authentication complete";
        }
    }
</script>
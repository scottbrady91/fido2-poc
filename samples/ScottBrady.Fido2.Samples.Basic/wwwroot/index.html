<h1>Click to register new (ES256 or RS256)</h1>
<label for="username">Username: </label><input id="username" type="text" />
<button onclick="register()">register</button>
<button onclick="authenticate()">authenticate</button>
<code id="result"></code>

<script>
    if (!window.PublicKeyCredential) {
        console.error("WebAuthn not supported by browser!")
    }

    async function register() {

        // get registration options from relying party
        let username = document.getElementById("username").value;
        let response = await fetch("/fido/register", {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                "username": username,
                "userDisplayName": username
            })
        });
        
        // cleanup options (convert Arrays into Uint8Arrays)
        let options = await response.json();
        options.challenge = new Uint8Array(options.challenge);
        options.user.id = new Uint8Array(options.user.id);

        // create new credential
        let credential = await navigator.credentials.create({publicKey: options});
        
        // prepare credential to be sent to relying party
        // body as base64 encoded (automatically decoded by ASP.NET Core)
        let publicKeyCredential = JSON.stringify({
            id: credential.id,
            rawId: btoa(String.fromCharCode.apply(null, new Uint8Array(credential.rawId))),
            type: credential.type,
            response: {
                attestationObject: btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.attestationObject))),
                clientDataJSON: btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.clientDataJSON)))
            }
            // TODO: optional transports
            // transports: credential.response.getTransports(), 
            // TODO: other functions to test
            // extensions: credential.getClientExtensionResults(),
            // authenticatorData: credential.response.getAuthenticatorData(),
            // publicKey: credential.response.getPublicKey(),
            // publicKeyAlgorithm: credential.response.getPublicKeyAlgorithm(),
        });
        console.log(publicKeyCredential);
        
        // send credentials to relying party
        let result = await fetch("/fido/register", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: publicKeyCredential
        });

        // output result to UI
        if (result.ok) {
            let output = document.getElementById("result");
            output.innerText = "Registration complete";
        } else {
            let output = document.getElementById("result");
            output.innerText = "Error!";
        }
    }

    async function authenticate() {

        // get authentication options from relying party
        let username = document.getElementById("username").value;
        let response = await fetch("/fido/authenticate", {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                "username": username
            })
        });

        // cleanup options (convert Arrays into Uint8Arrays)
        let options = await response.json();
        options.challenge = new Uint8Array(options.challenge);
        for (const allowCredential of options.allowCredentials) {
            allowCredential.id = new Uint8Array(allowCredential.id)
        }

        // authenticate credential
        let credential = await navigator.credentials.get({
            publicKey: {
                challenge: options.challenge,
                allowCredentials: options.allowCredentials
            }
        });

        // prepare credential to be sent to relying party
        // body as base64 encoded (automatically decoded by ASP.NET Core)
        let publicKeyCredential = JSON.stringify({
            id: credential.id,
            rawId: btoa(String.fromCharCode.apply(null, new Uint8Array(credential.rawId))),
            type: credential.type,
            response: {
                authenticatorData: btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.authenticatorData))),
                signature: btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.signature))),
                userHandle: btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.userHandle))),
                clientDataJSON: btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.clientDataJSON)))
            }
        });
        console.log(publicKeyCredential);

        // send result to relying party
        let result = await fetch("/fido/authenticate", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: publicKeyCredential
        });

        // output result to UI
        if (result.ok) {
            let output = document.getElementById("result");
            output.innerText = "Authentication complete";
        } else {
            let output = document.getElementById("result");
            output.innerText = "Error!";
        }
    }
</script>